#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROFILE_DIR="$SCRIPT_DIR/archiso_profile"
WORK_DIR="$SCRIPT_DIR/archiso_work" # tmp
OUTPUT_DIR="$SCRIPT_DIR/a"
BUILD_DATE=$(date '+%Y.%m.%d')
THREADS="${THREADS:-$(nproc)}"
SILENT_MODE="${SILENT_MODE:-0}"
CLEANUP="${CLEANUP:-1}"  # Set to 0 to preserve build files for debugging

# Cleanup function
cleanup() {
    if [ "$CLEANUP" = "1" ]; then
        echo "Cleaning up build directories..."
        [ -d "$PROFILE_DIR" ] && rm -rf "$PROFILE_DIR"
        [ -d "$WORK_DIR" ] && sudo rm -rf "$WORK_DIR"
        echo "Cleanup complete."
    else
        echo "CLEANUP=0, preserving build directories for inspection."
    fi
}

# Error handler - cleanup and exit
error_exit() {
    echo "ERROR: $1" >&2
    cleanup
    exit 1
}

# Cleanup on interrupt or error
trap 'echo "Script interrupted!"; cleanup; exit 130' INT TERM
trap 'cleanup; exit 1' ERR

echo "Setting up archiso profile..."
mkdir -p "$PROFILE_DIR" || error_exit "Failed to create profile directory"

echo "Creating root FS..."
mkdir -p "$PROFILE_DIR/airootfs/root" || error_exit "Failed to create airootfs"

echo "Copy releng profile..."
cp -r /usr/share/archiso/configs/releng/* "$PROFILE_DIR" || error_exit "Failed to copy releng profile"

echo "Mod ISO name..."
sed -i 's/^iso_name=.*/iso_name="ArchInt"/' "$PROFILE_DIR/profiledef.sh"

echo "Adding fb_term and fonts to airootfs..."
cd "$SCRIPT_DIR" || exit
mkdir -p "$PROFILE_DIR/airootfs/root/fb_term"

# Copy fb_term binary
if [ ! -f "$SCRIPT_DIR/out/fb_term" ]; then
    error_exit "fb_term binary not found at $SCRIPT_DIR/out/fb_term"
fi
cp "$SCRIPT_DIR/out/fb_term" "$PROFILE_DIR/airootfs/root/fb_term/" || error_exit "Failed to copy fb_term"

# Copy font bundle
if [ ! -f "$SCRIPT_DIR/in/noto-fonts-bundle.tar.gz" ]; then
    error_exit "Font bundle not found at $SCRIPT_DIR/in/noto-fonts-bundle.tar.gz"
fi
cp "$SCRIPT_DIR/in/noto-fonts-bundle.tar.gz" "$PROFILE_DIR/airootfs/root/fb_term/" || error_exit "Failed to copy font bundle"

echo "Mod pkg list..."
{
    echo "git"
    echo "util-linux"  # Provides libutil for pty support
} >> "$PROFILE_DIR/packages.x86_64"

echo "Creating customize_airootfs.sh..."
cat > "$PROFILE_DIR/airootfs/root/customize_airootfs.sh" << 'EOF'
#!/usr/bin/env bash
set -e -u
pacman-key --init

echo "==> Customizing airootfs..."
echo "Installing fb_term..."

# Extract fonts to system location
cd /
tar -xzf /root/fb_term/noto-fonts-bundle.tar.gz

# Install fb_term binary
install -Dm755 /root/fb_term/fb_term /usr/local/bin/fb_term

# Set capabilities for framebuffer access
setcap 'cap_sys_tty_config+ep' /usr/local/bin/fb_term

# Add root to video and input groups
usermod -aG video root
usermod -aG input root

echo "fb_term setup complete!"
EOF

chmod +x "$PROFILE_DIR/airootfs/root/customize_airootfs.sh" || error_exit "Failed to make customize_airootfs.sh executable"
echo "Creating .zlogin message..."
cat >> "$PROFILE_DIR/airootfs/root/.zlogin" << 'ZLOGINEOF'
# fb_term is available for full Unicode support
if [ "$TERM" = "linux" ]; then
    echo ""
    echo "==> For full Unicode support (CJK, Arabic, etc), run:"
    echo "    fb_term /usr/share/fonts/noto/NotoSans-Regular.ttf 16"
    echo ""
fi
ZLOGINEOF

# Append custom MOTD
cat >> "$PROFILE_DIR/airootfs/etc/motd" << EOF

        INTERNATIONAL ISO PROJECT
        Media Gen: ${BUILD_DATE}
  Chinese, Japanese, Korean, Arabic,...
        Useful commands:
        loadkeys "kb layout"
    INSTALL: UP KEY ↑ then ENTER ╛ KEY
EOF

# add git clone command to zsh history testing
echo "Adding git clone to zsh history..."
cat > "$PROFILE_DIR/airootfs/root/.zsh_history" << 'HISTEOF'
: 1728000000:0;pacman-key --init && git clone https://github.com/archlinux/archinstall && cd archinstall-patch && python -m archinstall
HISTEOF

echo "Styling pacman.conf (Color + ILoveCandy)..."
# Ensure pacman.conf exists in airootfs/etc
mkdir -p "$PROFILE_DIR/airootfs/etc"
if [ ! -f "$PROFILE_DIR/airootfs/etc/pacman.conf" ]; then
    # Copy from the build profile's pacman.conf
    cp "$PROFILE_DIR/pacman.conf" "$PROFILE_DIR/airootfs/etc/pacman.conf"
fi

# fun stuff
PACMAN_CONF="$PROFILE_DIR/airootfs/etc/pacman.conf"
sed -i 's/^#Color$/Color/' "$PACMAN_CONF"
if ! grep -q "ILoveCandy" "$PACMAN_CONF"; then
    sed -i '/^# Misc options$/a ILoveCandy' "$PACMAN_CONF"
fi

# show pre info
echo "Building ISO with mkarchiso..."
echo "Silent mode: $SILENT_MODE"
echo "Using $THREADS threads for build"

# tmp dir
mkdir -p "$WORK_DIR"
ISO_LABEL="int_archlinux-${BUILD_DATE}"

# Will prompt to build
if [ "$SILENT_MODE" = "1" ]; then
    sudo taskset -c 0-$((THREADS-1)) mkarchiso -v -w "$WORK_DIR" -o "$OUTPUT_DIR" -L "$ISO_LABEL" "$PROFILE_DIR" >/dev/null 2>&1 || error_exit "mkarchiso failed"
else
    sudo taskset -c 0-$((THREADS-1)) mkarchiso -v -w "$WORK_DIR" -o "$OUTPUT_DIR" -L "$ISO_LABEL" "$PROFILE_DIR" || error_exit "mkarchiso failed"
fi

echo ""
echo "✓ SUCCESS! ISO created in: $OUTPUT_DIR"
echo ""

cleanup
exit 0